<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Firebase github Redirect Login</title>
    </head>
    <body>
        <h2>Login with github (Redirect)</h2>
        <span
            >this is the most minimal implementation. check the console for your
            user object.</span
        ><br />
        <button id="loginBtn">Login with github</button>
        <button id="logoutBtn" style="display: none">Logout</button>

        <script type="module">
            import { FirebaseError, initializeApp } from "firebase/app";
            import {
                getAuth,
                GithubAuthProvider,
                signInWithRedirect,
                getRedirectResult,
                onAuthStateChanged,
                signOut,
            } from "firebase/auth";
            import { getEnv } from "/src/utils.ts";

            const env = getEnv();
            const firebaseConfig = {
                apiKey: env.FIREBASE_API_KEY,
                authDomain: env.FIREBASE_AUTH_DOMAIN,
                projectId: env.FIREBASE_PROJECT_ID,
                storageBucket: env.FIREBASE_STORAGE_BUCKET,
                messagingSenderId: env.FIREBASE_MESSAGING_SENDER_ID,
                appId: env.FIREBASE_APP_ID,
                measurementId: env.FIREBASE_MEASUREMENT_ID,
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);

            const provider = new GithubAuthProvider();
            const loginBtn = document.getElementById("loginBtn");
            const logoutBtn = document.getElementById("logoutBtn");

            loginBtn.addEventListener("click", async () => {
                await signInWithRedirect(auth, provider);
            });

            getRedirectResult(auth)
                .then((result) => {
                    console.log("github getRedirectResult:", result);
                    if (result) {
                        const credential =
                            GithubAuthProvider.credentialFromResult(result);
                        const token = credential.accessToken;
                        console.log("github access token:", token);
                    }
                })
                .catch((error) => {
                    console.error("Redirect error:", error);
                });

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log(`Logged in as: ${user.displayName}`, user);
                    loginBtn.style.display = "none";
                    logoutBtn.style.display = "inline-block";
                } else {
                    console.log("Not logged in.");
                    loginBtn.style.display = "inline-block";
                    logoutBtn.style.display = "none";
                }
            });

            logoutBtn.addEventListener("click", () => {
                signOut(auth);
            });
        </script>
    </body>
</html>
